# Required-Start:    mount-usb-gadget.sh
# Required-Stop:
# Default-Start:     S
# Default-Stop:
# Short-Description: load usb ncm-serial gadget
# Description:       The original beaglebone black BSP uses systemd
#                    for starting up USB based network services. With
#                    older OE distributions that might not reliably work.
#                    We start the required support script provided by
#                    the layer meta-beagleboard-extra manually therefore.
### END INIT INFO

. /etc/default/rcS

modprobe g_ether
modprobe cdc_ether
modprobe cdc_subset
modprobe cdc_ncm
modprobe xt_REDIRECT
modprobe xt_tcpudp

sleep 1

/sbin/ifconfig usb0 192.168.140.218 netmask 255.255.255.252
/sbin/ifconfig eth0 192.168.11.2 netmask 255.255.255.252

echo 1 > /proc/sys/net/ipv4/ip_forward

/usr/sbin/iptables -t nat -A PREROUTING -p tcp -d 192.168.11.2 --dport 23451 -j DNAT --to 192.168.140.217:451
/usr/sbin/iptables -t nat -A PREROUTING -p udp -d 192.168.11.2 --dport 23451 -j DNAT --to 192.168.140.217:451
/usr/sbin/iptables -t nat -A PREROUTING -p udp -d 192.168.140.218 --dport 451 -j DNAT --to 192.168.1.1:23451
/usr/sbin/iptables -t nat -A PREROUTING -p tcp -d 192.168.140.218 --dport 451 -j DNAT --to 192.168.1.1:23451

/usr/sbin/udhcpd -f -S /etc/udhcpd.conf &

: exit 0
